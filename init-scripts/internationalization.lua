------------------------------------------------------------------------------
-- ISO 639-2 language codes taken trom 
-- http://www.loc.gov/standards/iso639-2/frelangn_ascii.html
------------------------------------------------------------------------------
local iso639 = [[
aar; Afar, afar
abk; Abkhazian
ace; Achinese
ach; Acoli
ada; Adangme
ady; adyghe
afa; Afro-Asiatic (Other); afro-asiatiques, autres langues
afh; Afrihili; afrihili
afr; Afrikaans; afrikaans
aka; Akan; akan
akk; Akkadian; akkadien
alb; Albanian; albanais
alb; Albania; albanais
ale; Aleut; aleoute
alg; Algonquian languages; algonquines, langues
alt; Southern Altai; altai du Sud
amh; Amharic; amharique
ang; English, Old (ca.450-1100); anglo-saxon (ca.450-1100)
apa; Apache languages; apache
ara; Arabic; arabe
arc; Aramaic; arameen
arg; Aragonese; aragonais
arm; Armenian; armenien
arn; Araucanian; araucan
arp; Arapaho; arapaho
art; Artificial (Other); artificielles, autres langues
arw; Arawak; arawak
asm; Assamese; assamais
ast; Asturian, Bable; asturien,  bable
ath; Athapascan languages; athapascanes, langues
aus; Australian languages; australiennes, langues
ava; Avaric; avar
ave; Avestan; avestique
awa; Awadhi; awadhi
aym; Aymara; aymara
aze; Azerbaijani; azeri

bad; Banda; banda
bai; Bamileke languages; bamilekes, langues
bak; Bashkir; bachkir
bal; Baluchi; baloutchi
bam; Bambara; bambara
ban; Balinese; balinais
baq; Basque; basque
bas; Basa; basa
bat; Baltic (Other); baltiques, autres langues
bej; Beja; bedja
bel; Belarusian; bielorusse
bem; Bemba; bemba
ben; Bengali; bengali
ber; Berber (Other); berberes, autres langues
bho; Bhojpuri; bhojpuri
bih; Bihari; bihari
bik; Bikol; bikol
bin; Bini; bini
bis; Bislama; bichlamar
bla; Siksika; blackfoot
bnt; Bantu (Other); bantoues, autres langues
bod; Tibetan; tibetain
bos; Bosnian; bosniaque
bra; Braj; braj
bre; Breton; breton
btk; Batak (Indonesia); batak (Indonesie)
bua; Buriat; bouriate
bug; Buginese; bugi
bul; Bulgarian; bulgare
bur; Burmese; birman
byn; Blin; Bilin

cad; Caddo; caddo
cai; Central American Indian (Other); indiennes d'Amerique centrale, autres langues
car; Carib; caribe
cat; Catalan; Valencian catalan; valencien
cau; Caucasian (Other); caucasiennes, autres langues
ceb; Cebuano; cebuano
cel; Celtic (Other); celtiques, autres langues
cha; Chamorro; chamorro
chb; Chibcha; chibcha
che; Chechen; tchetchene
chg; Chagatai; djaghatai
chi; Chinese; chinois
chk; Chuukese; chuuk
chm; Mari; mari
chn; Chinook jargon; chinook, jargon
cho; Choctaw; choctaw
chp; Chipewyan; chipewyan
chr; Cherokee; cherokee
chu; Church Slavic;  Old Slavonic;  Church Slavonic;  Old Bulgarian;  Old Church Slavonic; 
     slavon d'eglise; vieux slave;  slavon liturgique;  vieux bulgare
chv; Chuvash; tchouvache
chy; Cheyenne; cheyenne
cmc; Chamic languages; chames, langues
cop; Coptic; copte
cor; Cornish; cornique
cos; Corsican; corse
cpe; Creoles and pidgins, English based (Other); creoles et pidgins anglais, autres
cpf; Creoles and pidgins, French-based (Other); creoles et pidgins francais, autres
cpp; Creoles and pidgins, Portuguese-based (Other); creoles et pidgins portugais, autres
cre; Cree; cree
crh; Crimean Tatar; Crimean Turkish, tatar de Crime
crp; Creoles and pidgins (Other); creoles et pidgins divers
csb; Kashubian; kachoube
cus; Cushitic (Other)' couchitiques, autres langues
cym; Welsh; gallois
cze; Czech; tcheque

dak; Dakota; dakota
dan; Danish; danois
dar; Dargwa; dargwa
day; Dayak; dayak
del; Delaware; delaware
den; Slave (Athapascan); esclave (athapascan)
deu; German; allemand
dgr; Dogrib; dogrib
din; Dinka; dinka
div; Divehi; maldivien
doi; Dogri; dogri
dra; Dravidian (Other); dravidiennes, autres langues
dua; Duala; douala
dum; Dutch, Middle (ca.1050-1350); neerlandais moyen (ca. 1050-1350)
dut; Dutch; Flemish, neerlandais; flamand
dyu; Dyula; dioula
dzo; Dzongkha; dzongkha

efi; Efik; efik
egy; Egyptian (Ancient); egyptien
eka; Ekajuk; ekajuk
ell; Greek, Modern (1453-); grec moderne (apres 1453)
elx; Elamite; elamite
eng; English; anglais
enm; English, Middle (1100-1500); anglais moyen (1100-1500)
epo; Esperanto; esperanto
est; Estonian; estonien
eus; Basque; basque
ewe; Ewe; ewe
ewo; Ewondo; ewondo

fan; Fang; fang
fao; Faroese; feroien
fas; Persian; persan
fat; Fanti; fanti
fij; Fijian; fidjien
fil; Filipino; Pilipino; filipino; pilipino
fin; Finnish; finnois
fiu; Finno-Ugrian (Other); finno-ougriennes, autres langues
fon; Fon; fon
fra; French; francais
fre; French; francais
frm; French, Middle (ca.1400-1600); francais moyen (1400-1600)
fro; French, Old (842-ca.1400); francais ancien (842-ca.1400)
fry; Frisian; frison
ful; Fulah; peul
fur; Friulian; frioulan

gaa; Ga; ga
gay; Gayo; gayo
gba; Gbaya; gbaya
gem; Germanic (Other); germaniques, autres langues
geo; Georgian; georgien
ger; German; allemand
gez; Geez; gueze
gil; Gilbertese; kiribati
gla; Gaelic; Scottish Gaelic; gaelique; gaelique ecossais
gle; Irish; irlandais
glg; Galician; galicien
glv; Manx; manx; mannois
gmh; German, Middle High (ca.1050-1500); allemand, moyen haut (ca. 1050-1500)
goh; German, Old High (ca.750-1050); allemand, vieux haut (ca. 750-1050)
gon; Gondi; gond
gor; Gorontalo; gorontalo
got; Gothic; gothique
grb; Grebo; grebo
grc; Greek, Ancient (to 1453); grec ancien (jusqu'a 1453)
gre; Greek, Modern (1453-); grec moderne (apres 1453)
grn; Guarani; guarani
guj; Gujarati; goudjrati
gwi; Gwich?in; gwich?in

hai; Haida; haida
hat; Haitian; Haitian Creole; haitien; creole haitien
hau; Hausa; haoussa
haw; Hawaiian; hawaien
heb; Hebrew; hebreu
her; Herero; herero
hil; Hiligaynon; hiligaynon
him; Himachali; himachali
hin; Hindi; hindi
hit; Hittite; hittite
hmn; Hmong; hmong
hmo; Hiri Motu; hiri motu
hrv; Croatian; croate
hun; Hungarian; hongrois
hup; Hupa; hupa
hye; Armenian; armenien

iba; Iban; iban
ibo; Igbo; igbo
ice; Icelandic; islandais
ido; Ido; ido
iii; Sichuan Yi; yi de Sichuan
ijo; Ijo; ijo
iku; Inuktitut; inuktitut
ile; Interlingue; interlingue
ilo; Iloko; ilocano
ina; Interlingua (International Auxiliary Language Association);
     interlingua (langue auxiliaire internationale)
inc; Indic (Other); indo-aryennes, autres langues
ind; Indonesian; indonesien
ine; Indo-European (Other); indo-europeennes, autres langues
inh; Ingush; ingouche
ipk; Inupiaq; inupiaq
ira; Iranian (Other); iraniennes, autres langues
iro; Iroquoian languages; iroquoises, langues (famille)
isl; Icelandic; islandais
ita; Italian; italien

jav; Javanese; javanais
jpn; Japanese; japonais
jpr; Judeo-Persian; judeo-persan
jrb; Judeo-Arabic; judeo-arabe

kaa; Kara-Kalpak; karakalpak
kab; Kabyle; kabyle
kac; Kachin; kachin
kal; Kalaallisut; Greenlandic; groenlandais
kam; Kamba; kamba
kan; Kannada; kannada
kar; Karen; karen
kas; Kashmiri; kashmiri
kat; Georgian; georgien
kau; Kanuri; kanouri
kaw; Kawi; kawi
kaz; Kazakh; kazakh
kbd; Kabardian; kabardien
kha; Khasi; khasi
khi; Khoisan (Other); khoisan, autres langues
khm; Khmer; khmer
kho; Khotanese; khotanais
kik; Kikuyu; Gikuyu; kikuyu
kin; Kinyarwanda; rwanda
kir; Kirghiz; kirghize
kmb; Kimbundu; kimbundu
kok; Konkani; konkani
kom; Komi; kom
kon; Kongo; kongo
kor; Korean; coreen
kos; Kosraean; kosrae
kpe; Kpelle; kpelle
krc; Karachay-Balkar; karatchai balkar
kro; Kru; krou
kru; Kurukh; kurukh
kua; Kuanyama; Kwanyama; kuanyama; kwanyama
kum; Kumyk; koumyk
kur; Kurdish; kurde
kut; Kutenai; kutenai

lad; Ladino; judeo-espagnol
lah; Lahnda; lahnda
lam; Lamba; lamba
lao; Lao; lao
lat; Latin; latin
lav; Latvian; letton
lez; Lezghian; lezghien
lim; Limburgan; Limburger; Limburgish; limbourgeois
lin; Lingala; lingala
lit; Lithuanian; lituanien
lol; Mongo; mongo
loz; Lozi; lozi
ltz; Luxembourgish; Letzeburgesch; luxembourgeois
lua; Luba-Lulua; luba-lulua
lub; Luba-Katanga; luba-katanga
lug; Ganda; ganda
lui; Luiseno; luiseno
lun; Lunda; lunda
luo; Luo (Kenya and Tanzania); luo (Kenya et Tanzanie)
lus; lushai; Lushai

mac; Macedonian; macedonien
mad; Madurese; madourais
mag; Magahi; magahi
mah; Marshallese; marshall
mai; Maithili; maithili
mak; Makasar; makassar
mal; Malayalam; malayalam
man; Mandingo; mandingue
mao; Maori; maori
map; Austronesian (Other); malayo-polynesiennes, autres langues
mar; Marathi; marathe
mas; Masai; massai
may; Malay; malais
mdf; Moksha; moksa
mdr; Mandar; mandar
men; Mende; mende
mga; Irish, Middle (900-1200); irlandais moyen (900-1200)
mic; Mi'kmaq; Micmac; mi'kmaq; micmac
min; Minangkabau; minangkabau
mis; Miscellaneous languages; diverses, langues
mkd; Macedonian; macedonien
mkh; Mon-Khmer (Other); mon-khmer, autres langues
mlg; Malagasy; malgache
mlt; Maltese; maltais
mnc; Manchu; mandchou
mni; Manipuri; manipuri
mno; Manobo languages; manobo, langues
moh; Mohawk; mohawk
mol; Moldavian; moldave
mon; Mongolian; mongol
mos; Mossi; more
mri; Maori; maori
msa; Malay; malais
mwl; Mirandese; mirandais
mul; Multiple languages; multilingue
mun; Munda languages; mounda, langues
mus; Creek; muskogee
mwr; Marwari; marvari
mya; Burmese; birman
myn; Mayan languages; maya, langues
myv; Erzya; erza

nah; Nahuatl; nahuatl
nai; North American Indian; indiennes d'Amerique du Nord, autres langues
nap; Neapolitan; napolitain
nau; Nauru; nauruan
nav; Navajo; Navaho; navaho
nbl; Ndebele, South; South Ndebele; ndebele du Sud
nde; Ndebele, North; North Ndebele; ndebele du Nord
ndo; Ndonga; ndonga
nds; Low German; Low Saxon; German, Low; Saxon, Low;
     bas allemand;  bas saxon;  allemand, bas;  saxon, bas
nep; Nepali; nepalais
new; Nepal Bhasa; Newari; nepal bhasa; newari
nia; Nias; nias
nic; Niger-Kordofanian (Other); nigero-congolaises, autres langues
niu; Niuean; niue
nld; Dutch; Flemish, neerlandais; flamand
nno; Norwegian Nynorsk; norvegien nynorsk
nob; Norwegian Bokmal; norvegien bokmal
nog; Nogai; nogai; nogay
non; Norse, Old; norrois, vieux
nor; Norwegian; norvegien
nso; Northern Sotho; Pedi; Sepedi; sotho du Nord; pedi; sepedi
nub; Nubian languages; nubiennes, langues
nwc; Classical Newari; Old Newari; Classical Nepal Bhasa; newari classique
nya; Chichewa; Chewa; Nyanja; chichewa; chewa; nyanja
nym; Nyamwezi; nyamwezi
nyn; Nyankole; nyankole
nyo; Nyoro; nyoro
nzi; Nzima; nzema

oci; Occitan (post 1500);  Provencal; occitan (apres 1500); provencal
oji; Ojibwa; ojibwa
ori; Oriya; oriya
orm; Oromo; galla
osa; Osage; osage
oss; Ossetian; Ossetic; ossete
ota; Turkish, Ottoman (1500-1928); turc ottoman (1500-1928)
oto; Otomian languages; otomangue, langues

paa; Papuan (Other); papoues, autres langues
pag; Pangasinan; pangasinan
pal; Pahlavi; pahlavi
pam; Pampanga; pampangan
pan; Panjabi; Punjabi; pendjabi
pap; Papiamento; papiamento
pau; Palauan; palau
peo; Persian, Old (ca.600-400 B.C.); perse, vieux (ca. 600-400 av. J.-C.)
per; Persian; persan
phi; Philippine (Other); philippines, autres langues
phn; Phoenician; phenicien
pli; Pali; pali
pol; Polish; polonais
pon; Pohnpeian; pohnpei
por; Portuguese; portugais
pra; Prakrit languages; prakrit
pro; Provencal, Old (to 1500); provencal ancien (jusqu'a 1500)
pus; Pushto; pachto

qaa-qtz; Reserved for local use; reservee a l'usage local
que; Quechua; quechua

raj; Rajasthani; rajasthani
rap; Rapanui; rapanui
rar; Rarotongan; rarotonga
roa; Romance (Other); romanes, autres langues
roh; Raeto-Romance; rheto-roman
rom; Romany; tsigane
ron; Romanian; roumain
run; Rundi; rundi
rus; Russian; russe

sad; Sandawe; sandawe
sag; Sango; sango
sah; Yakut; iakoute
sai; South American Indian (Other); indiennes d'Amerique du Sud, autres langues
sal; Salishan languages; salish, langues
sam; Samaritan Aramaic; samaritain
san; Sanskrit; sanskrit
sas; Sasak; sasak
sat; Santali; santal
scc; Serbian; serbe
scn; Sicilian; sicilien
sco; Scots; ecossais
scr; Croatian; croate
sel; Selkup; selkoupe
sem; Semitic (Other); semitiques, autres langues
sga; Irish, Old (to 900); irlandais ancien (jusqu'a 900)
sgn; Sign Languages; langues des signes
shn; Shan; chan
sid; Sidamo; sidamo
sin; Sinhalese; Sinhala; singhalais
sio; Siouan languages; sioux, langues
sit; Sino-Tibetan (Other); sino-tibetaines, autres langues
sla; Slavic (Other); slaves, autres langues
slk; Slovak; slovaque
slo; Slovak; slovaque
slv; Slovenian; slovene
sma; Southern Sami; sami du Sud
sme; Northern Sami; sami du Nord
smi; Sami languages (Other); sami, autres langues
smj; Lule Sami; sami de Lule
smn; Inari Sami; sami d'Inari
smo; Samoan; samoan
sms; Skolt Sami; sami skolt
sna; Shona; shona
snd; Sindhi; sindhi
snk; Soninke; soninke
sog; Sogdian; sogdien
som; Somali; somali
son; Songhai; songhai
sot; Sotho, Southern; sotho du Sud
spa; Spanish; Castilian, espagnol; castillan
sqi; Albanian; albanais
srd; Sardinian; sarde
srp; Serbian; serbe
srr; Serer; serere
ssa; Nilo-Saharan (Other); nilo-sahariennes, autres langues
ssw; Swati; swati
suk; Sukuma; sukuma
sun; Sundanese; soundanais
sus; Susu; soussou
sux; Sumerian; sumerien
swa; Swahili; swahili
swe; Swedish; suedois
syr; Syriac; syriaque

tah; Tahitian; tahitien
tai; Tai (Other); thaies, autres langues
tam; Tamil; tamoul
tat; Tatar; tatar
tel; Telugu; telougou
tem; Timne; temne
ter; Tereno; tereno
tet; Tetum; tetum
tgk; Tajik; tadjik
tgl; Tagalog; tagalog
tha; Thai; thai
tib; Tibetan; tibetain
tig; Tigre; tigre
tir; Tigrinya; tigrigna
tiv; Tiv; tiv
tkl; Tokelau; tokelau
tlh; Klingon; tlhIngan-Hol; klingon
tli; Tlingit; tlingit
tmh; Tamashek; tamacheq
tog; Tonga (Nyasa); tonga (Nyasa)
ton; Tonga (Tonga Islands); tongan (Iles Tonga)
tpi; Tok Pisin; tok pisin
tsi; Tsimshian; tsimshian
tsn; Tswana; tswana
tso; Tsonga; tsonga
tuk; Turkmen; turkmene
tum; Tumbuka; tumbuka
tup; Tupi languages; tupi, langues
tur; Turkish; turc
tut; Altaic (Other); altaiques, autres langues
tvl; Tuvalu; tuvalu
twi; Twi; twi
tyv; Tuvinian; touva

udm; Udmurt; oudmourte
uga; Ugaritic; ougaritique
uig; Uighur; Uyghur; ouigour
ukr; Ukrainian; ukrainien
umb; Umbundu; umbundu
und; Undetermined; indeterminee
urd; Urdu; ourdou
uzb; Uzbek; ouszbek

vai; Vai; vai
ven; Venda; venda
vie; Vietnamese; vietnamien
vol; Volapuk; volapuk
vot; Votic; vote

wak; Wakashan languages; wakashennes, langues
wal; Walamo; walamo
war; Waray; waray
was; Washo; washo
wel; Welsh; gallois
wen; Sorbian languages; sorabes, langues
wln; Walloon; wallon
wol; Wolof; wolof
xal; Kalmyk; kalmouk
xho; Xhosa; xhosa

yao; Yao; yao
yap; Yapese; yapois
yid; Yiddish; yiddish
yor; Yoruba; yoruba
ypk; Yupik languages; yupik, langues

zap; Zapotec; zapoteque
zen; Zenaga; zenaga
zha; Zhuang; Chuang; zhuang; chuang
zho; Chinese, chinois
znd; Zande; zande
zul; Zulu; zoulou
zun; Zuni; zuni
]]

------------------------------------------------------------------------------
-- global table, which contains lookups "language string" -> "language code"
-- for all the languages, supported by the game
------------------------------------------------------------------------------

LanguagesList = {}

------------------------------------------------------------------------------
-- global table which stores messages translated to current language
------------------------------------------------------------------------------

TranslatedMessages = {}

------------------------------------------------------------------------------
-- Loads translated messages from po-file into a table 
-- of the form "English message" -> "Translated message"
--
-- Each translation in the po-file consists of two entries on separate lines,
-- msgid with the original text, and msgstr with the translated text.  E.g.:
--   msgid "CANCEL"
--   msgstr "ABBRUCH"
------------------------------------------------------------------------------

local function load_translated_messages(tbl, filename)
    local mode
    local key
    local str

    -- process a single translation message: key -> str
    local function add_translation_string(key, str)
        if mode == "msgstr" and key ~= "" and str ~= "" then 
            -- validate c-string format for translation and original message
            -- (primitive and not quite correct for all cases, but should catch 
            -- some errors)
            local function get_c_string_format_digest(msg)
                local result = ""
                for x in string.gfind(msg, "%%[%.%-%d]*[l]?([suidxfc])") do 
                    result = result .. x
                end
                return result
            end

            if get_c_string_format_digest(key) ~= get_c_string_format_digest(str) then
                Warning("Invalid translation for '%s' in the language file %s", key, filename)
            else
                key = string.gsub(key, "\\n", "\n")
                str = string.gsub(str, "\\n", "\n")
                key = string.gsub(key, "\\\"", "\"")
                str = string.gsub(str, "\\\"", "\"")

                tbl[key] = str 
            end
        end
    end

    for l in io.lines(filename) do
        if string.find(l, "^%s*msgid") then
            assert(mode == nil or mode == "msgstr")
            add_translation_string(key, str)
            mode = "msgid"
            str = ""
        elseif string.find(l, "^%s*msgstr") then
            assert(mode == "msgid")
            mode = "msgstr"
            key = str
            str = ""
        end
    
        local _, _, string_data = string.find(l, "^[^#\"]*\"(.*)\"")
        if string_data then str = str .. string_data end
    end

    add_translation_string(key, str)

    return tbl
end

------------------------------------------------------------------------------
-- Loads textfile with tips (one per line) into a table.
-- The text for the tips is taken directly from the wiki-page at 
-- http://ufo2000.lxnt.info/pmwiki/index.php/Main/TipOfTheDay,
-- formatted as an unnumbered list, e.g.: "* Text of Tip"
------------------------------------------------------------------------------

-- global table for tips:
TipsOfTheDay = {}

local function load_tips(tbl, filename)
    local str
    local n = 0

    for l in io.lines(filename) do
        if string.find(l, "^%*") then  -- ignore lines without "*"
            n = n + 1
            local _, _, str = string.find(l, "^[%*%s]+(.*)")
            tbl[n] = str 
          --Message("Tip %3d: '%s'", n, str)
        end
    end
    tbl[0] = n 

    return tbl
end

------------------------------------------------------------------------------
-- Test if file exists and can be read:
------------------------------------------------------------------------------
function FileExists(filename)
    local fh = io.open(filename, "rb")
    if fh then fh:close() return true end
    return nil 
end

------------------------------------------------------------------------------
-- Try to set language-file for game messages and tips-of-the-day:
------------------------------------------------------------------------------
function SetLanguage(lng)
    local lng_code = LanguagesList[lng] or "?"
    local fn = ufo2000_dir .. "/translations/ufo2000-" .. lng_code .. ".po";
    if lng_code and lng_code ~= "eng" and FileExists(fn) then
        TranslatedMessages = {}
        local result, errcode = pcall(load_translated_messages, TranslatedMessages, fn)
        if not result then Error(errcode) end
        Message("Language set to: %s", lng)
    else
        TranslatedMessages = {}
        Message("Language reset")
    end

    fn = ufo2000_dir .. "/translations/tips-" .. lng .. ".txt";
    if FileExists(fn) then
        load_tips(TipsOfTheDay, fn)
    else
        TipsOfTheDay[1] = "Visit http://ufo2000.sourceforge.net !"
        TipsOfTheDay[2] = "Have Fun !"
        TipsOfTheDay[0] = 2
    end
    Message("Tips-of-the-day: %s %d", lng, TipsOfTheDay[0] )
end

------------------------------------------------------------------------------
-- Check for the available language translations, lill
------------------------------------------------------------------------------

LanguagesList["English"] = "eng" -- English is always available

for l in string.gfind(iso639, "([^\r\n]*)[\r\n]*") do
    local _, _, lng_code, lng_name = string.find(l, "^(%a%a%a)%;%s*([^;]+)")
    if lng_code then
        local fn = ufo2000_dir .. "/translations/ufo2000-" .. lng_code .. ".po";
        if FileExists(fn) then
            local dummy = {}
            local result, errcode = pcall(load_translated_messages, dummy, fn)
            if result then
                LanguagesList[lng_name] = lng_code
                Message("Translation found: %s", lng_name)
            else
                Warning("%s", errcode)
            end
        end
    end
end
